// Copyright 2009 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE-go file.

package rand

import (
	"math"
)

/*
 * Normal distribution
 *
 * See "The Ziggurat Method for Generating Random Variables"
 * (Marsaglia & Tsang, 2000)
 * http://www.jstatsoft.org/v05/i08/paper [pdf]
 *
 * Fixed correlation and increased number of distinct results generated,
 * see https://github.com/flyingmutant/rand/issues/3
 */

const (
	rn = 3.6541528853610088
)

func absInt64(i int64) uint64 {
	if i < 0 {
		return uint64(-i)
	}
	return uint64(i)
}

// NormFloat64 returns a normally distributed float64 in
// the range -math.MaxFloat64 through +math.MaxFloat64 inclusive,
// with standard normal distribution (mean = 0, stddev = 1).
// To produce a different normal distribution, callers can
// adjust the output using:
//
//  sample = NormFloat64() * desiredStdDev + desiredMean
//
func (r *Rand) NormFloat64() float64 {
	for {
		v := r.Uint64()
		j := int64(v) >> 11 // Possibly negative
		i := v & 0xFF
		x := float64(j) * wn[i]
		if absInt64(j) < kn[i] {
			// This case should be hit better than 99% of the time.
			return x
		}

		if i == 0 {
			// This extra work is only required for the base strip.
			for {
				x = -math.Log(r.Float64()) * (1.0 / rn)
				y := -math.Log(r.Float64())
				if y+y >= x*x {
					break
				}
			}
			if j > 0 {
				return rn + x
			}
			return -rn - x
		}
		if fn[i]+r.Float64()*(fn[i-1]-fn[i]) < math.Exp(-.5*x*x) {
			return x
		}
	}
}

var kn = [256]uint64{
	0xef33d8025bc39, 0x0, 0xc08be98f2abf4, 0xda354faba41f4,
	0xe51f67ec04991, 0xeb255e9d2fa2d, 0xeef4b817e2210, 0xf19470af9cc77,
	0xf37ed61ff7127, 0xf4f469560df8f, 0xf61a5e41b6bde, 0xf707a75536925,
	0xf7cb2ec281ebe, 0xf86f10c6337d7, 0xf8fa657830a7b, 0xf9724c74db925,
	0xf9da907dbe04e, 0xfa360f581e82e, 0xfa86fde5b3bbd, 0xfacf160d34657,
	0xfb0fb6718ac00, 0xfb49f8d5368f6, 0xfb7ec2366f3bc, 0xfbaece9a1db41,
	0xfbdab9d0402f2, 0xfc03060ff6415, 0xfc28210379aa8, 0xfc4a67ae254c3,
	0xfc6a2977ae7a3, 0xfc87aa928908b, 0xfca325e4bd8d3, 0xfcbcce9021dc6,
	0xfcd4d12f834c5, 0xfceb54d8fe7e7, 0xfd007bf1dc4c6, 0xfd1464dd6c0ba,
	0xfd272a8e2f060, 0xfd38e4ff0c564, 0xfd49a9990b0f1, 0xfd598b8920bf9,
	0xfd689c08e96bd, 0xfd76ea9c8e52a, 0xfd848547b0604, 0xfd9178bad29ca,
	0xfd9dd07a7ab31, 0xfda9970105c08, 0xfdb4d5dc02bb8, 0xfdbf95c5bfa82,
	0xfdc9debb99848, 0xfdd3b8118707f, 0xfddd288342d86, 0xfde6364369d6f,
	0xfdeee708d4f6c, 0xfdf7401a6b25e, 0xfdff46599eb80, 0xfe06fe4bc2342,
	0xfe0e6c225a0b8, 0xfe1593c28b6ba, 0xfe1c78cbc3e15, 0xfe231e9db1b33,
	0xfe29885da1a28, 0xfe2fb8fb54026, 0xfe35b33558bf7, 0xfe3b799cffee2,
	0xfe410e99eac3f, 0xfe46746d475ff, 0xfe4bad34c082f, 0xfe50baed29401,
	0xfe559f74ebb5b, 0xfe5a5c8e410ff, 0xfe5ef3e13857d, 0xfe6366fd90f73,
	0xfe67b75c6d47b, 0xfe6be661e10b5, 0xfe6ff55e5f403, 0xfe73e5900a617,
	0xfe77b823e9d56, 0xfe7b6e3706fc3, 0xfe7f08d77416b, 0xfe8289053efb9,
	0xfe85efb35166c, 0xfe893dc84079b, 0xfe8c741f0cdf8, 0xfe8f9387d4e36,
	0xfe929cc879a62, 0xfe95909d38833, 0xfe986fb9399ef, 0xfe9b3ac7147b7,
	0xfe9df2694b62a, 0xfea0973abe5d3, 0xfea329cf16600, 0xfea5aab32948c,
	0xfea81a6d5737c, 0xfeaa797de1c56, 0xfeacc85f3d889, 0xfeaf07865e5a9,
	0xfeb13762feb82, 0xfeb3585fe29bc, 0xfeb56ae316229, 0xfeb76f4e28470,
	0xfeb965fe61f8d, 0xfebb4f4cf9cf9, 0xfebd2b8f4494f, 0xfebefb16e2dbf,
	0xfec0be31ebd6c, 0xfec2752b1599a, 0xfec42049daf5c, 0xfec5bfd29f121,
	0xfec75406cee81, 0xfec8dd2500c42, 0xfeca5b6911ea1, 0xfecbcf0c42790,
	0xfecd38454faa9, 0xfece97488c848, 0xfecfec47f914f, 0xfed13773584c1,
	0xfed278f84489e, 0xfed3b10242ee9, 0xfed4dfbad580c, 0xfed605498c37c,
	0xfed721d414f89, 0xfed8357e4a924, 0xfed9406a42c6d, 0xfeda42b85b6aa,
	0xfedb3c8746a5a, 0xfedc2df4165fa, 0xfedd171a46dfc, 0xfeddf813c8a7d,
	0xfeded0f90992b, 0xfedfa1e0fd3c0, 0xfee06ae124b72, 0xfee12c0d959b5,
	0xfee1e57900690, 0xfee29734b64d6, 0xfee34150ae46e, 0xfee3e3db89af0,
	0xfee47ee2982a8, 0xfee51271db03c, 0xfee59e9407ef7, 0xfee623528b3e5,
	0xfee6a0b5897a9, 0xfee716c3e0733, 0xfee7858327b3b, 0xfee7ecf7b0674,
	0xfee84d2484a6e, 0xfee8a60b66300, 0xfee8f7accc80f, 0xfee94207e2598,
	0xfee9851a829aa, 0xfee9c0e13481a, 0xfee9f557273b4, 0xfeea22762cc6f,
	0xfeea4836b426d, 0xfeea668fc2d34, 0xfeea7d76ed6bc, 0xfeea8ce04f9ce,
	0xfeea94be832ff, 0xfeea9502963d4, 0xfeea8d9c00723, 0xfeea7e789761a,
	0xfeea678481cec, 0xfeea48aa29e4a, 0xfeea21d22e4a2, 0xfee9f2e351fed,
	0xfee9bbc26aef8, 0xfee97c524f2ad, 0xfee93473c0a03, 0xfee8e405574e0,
	0xfee88ae369c44, 0xfee828e7f3dc8, 0xfee7bdea7b854, 0xfee749bff37cc,
	0xfee6cc3a9bd2c, 0xfee64529e004d, 0xfee5b45a32856, 0xfee51994e5784,
	0xfee474a00069d, 0xfee3c53e12c1e, 0xfee30b2e02aa7, 0xfee2462ad81d4,
	0xfee175eb83c2a, 0xfee09a22a1417, 0xfedfb27e3499c, 0xfedebea76213d,
	0xfeddbe422044f, 0xfedcb0ece39a5, 0xfedb964042cc6, 0xfeda6dce9389c,
	0xfed937237e95f, 0xfed7f1c38a80a, 0xfed69d2b9bffe, 0xfed538d06add3,
	0xfed3c41dea3f7, 0xfed23e76a2fac, 0xfed0a732fe617, 0xfecefda07fe08,
	0xfecd4100eb78c, 0xfecb708956e89, 0xfec98b6123096, 0xfec790a0da94e,
	0xfec57f50f31d4, 0xfec356686c938, 0xfec114cb4b30b, 0xfebeb948e6fa7,
	0xfebc429a0b668, 0xfeb9af5ee0cb3, 0xfeb6fe1c98519, 0xfeb42d3ad1f75,
	0xfeb13b00b2d23, 0xfeae2591a02c0, 0xfeaaeae99222d, 0xfea788d8ee2fe,
	0xfea3fcffd73bc, 0xfea044c8dd9ce, 0xfe9c5d62f5612, 0xfe9843ba9477a,
	0xfe93f471d4700, 0xfe8f6bd76c5ad, 0xfe8aa5dc4e8bd, 0xfe859e07ab1c1,
	0xfe804f690a917, 0xfe7ab48823396, 0xfe74c751f6a7c, 0xfe6e8102aa1d9,
	0xfe67da0b6abaf, 0xfe60c9f383055, 0xfe5947338f718, 0xfe51470977256,
	0xfe48bd436f42d, 0xfe3f9bffd1e0d, 0xfe35d35eeb171, 0xfe2b5122fe4d2,
	0xfe2000399552b, 0xfe13c827882e8, 0xfe068c4ee6783, 0xfdf82b02b717d,
	0xfde87c57efe7c, 0xfdd7509c63bce, 0xfdc46e529bee3, 0xfdaf8f82e0252,
	0xfd985e1b2ba43, 0xfd7e6ef48ced0, 0xfd613adbd64d6, 0xfd40149e2efda,
	0xfd1a1a7b4c772, 0xfcee204761f61, 0xfcba8d85e1171, 0xfc7d26ecd2cde,
	0xfc32b2f1e22a1, 0xfbd6581c0b7e7, 0xfb606c40053d6, 0xfac40582a2805,
	0xf9e971e014510, 0xf89fa48a41d49, 0xf66c5f7f02f1a, 0xf1a5a4b331a0a,
}
var wn = [256]float64{
	8.683627060828347e-16, 4.779330174137267e-17, 6.354352416409944e-17,
	7.454870480493283e-17, 8.329366815173086e-17, 9.068060404526636e-17,
	9.714860076096691e-17, 1.0294750313816366e-16, 1.0823430288059398e-16,
	1.1311470195750139e-16, 1.176635945668836e-16, 1.2193617278400333e-16,
	1.2597439914340668e-16, 1.29810998859829e-16, 1.3347203736556423e-16,
	1.3697864842315415e-16, 1.4034823000997246e-16, 1.4359529451821394e-16,
	1.4673208742137558e-16, 1.4976904668172093e-16, 1.5271515003384505e-16,
	1.5557818169255744e-16, 1.5836494009092026e-16, 1.6108140175081783e-16,
	1.6373285203782025e-16, 1.6632399058237965e-16, 1.6885901708498368e-16,
	1.7134170176385783e-16, 1.737754436569508e-16, 1.7616331922835076e-16,
	1.7850812316814456e-16, 1.808124028564033e-16, 1.8307848764671204e-16,
	1.8530851388465584e-16, 1.8750444639224402e-16, 1.89668097006281e-16,
	1.9180114064694653e-16, 1.939051293048371e-16, 1.9598150426489889e-16,
	1.9803160682991597e-16, 2.0005668776139014e-16, 2.0205791561939507e-16,
	2.0403638415350158e-16, 2.0599311887275664e-16, 2.079290829028791e-16,
	2.0984518222246106e-16, 2.1174227035637893e-16, 2.1362115259329158e-16,
	2.1548258978462424e-16, 2.1732730177446953e-16, 2.1915597050311427e-16,
	2.2096924282120992e-16, 2.22767733046767e-16, 2.2455202529302934e-16,
	2.263226755917564e-16, 2.2808021383341485e-16, 2.2982514554317305e-16,
	2.315579535093469e-16, 2.332790992789948e-16, 2.349890245336728e-16,
	2.366881523568909e-16, 2.3837688840352875e-16, 2.40055621980348e-16,
	2.417247270457584e-16, 2.4338456313612904e-16, 2.450354762251786e-16,
	2.4667779952230967e-16, 2.483118542151577e-16, 2.4993795016110384e-16,
	2.515563865320337e-16, 2.531674524162129e-16, 2.547714273807805e-16,
	2.563685819980345e-16, 2.579591783383901e-16, 2.5954347043262876e-16,
	2.611217047058219e-16, 2.626941203851006e-16, 2.642609498832549e-16,
	2.6582241915997437e-16, 2.673787480623876e-16, 2.689301506464203e-16,
	2.7047683548036554e-16, 2.720190059319464e-16, 2.7355686044004813e-16,
	2.750905927722038e-16, 2.766203922688329e-16, 2.781464440751549e-16,
	2.7966892936163e-16, 2.811880255337155e-16, 2.827039064316677e-16,
	2.842167425210666e-16, 2.857267010746922e-16, 2.8723394634633605e-16,
	2.8873863973709217e-16, 2.9024093995463403e-16, 2.9174100316595007e-16,
	2.9323898314397935e-16, 2.9473503140856024e-16, 2.9622929736207887e-16,
	2.977219284201806e-16, 2.9921307013788433e-16, 3.0070286633142135e-16,
	3.021914591960996e-16, 3.036789894204787e-16, 3.051655962971254e-16,
	3.066514178302039e-16, 3.08136590840143e-16, 3.096212510656104e-16,
	3.1110553326301216e-16, 3.1258957130372744e-16, 3.140734982692768e-16,
	3.1555744654461683e-16, 3.170415479097441e-16, 3.185259336297864e-16,
	3.2001073454375126e-16, 3.2149608115209917e-16, 3.2298210370330026e-16,
	3.244689322795327e-16, 3.2595669688167497e-16, 3.2744552751374195e-16,
	3.2893555426691234e-16, 3.3042690740329225e-16, 3.319197174395586e-16,
	3.3341411523062455e-16, 3.349102320534691e-16, 3.364081996912716e-16,
	3.379081505179939e-16, 3.394102175835517e-16, 3.4091453469971913e-16,
	3.424212365269121e-16, 3.439304586619971e-16, 3.4544233772727603e-16,
	3.4695701146079963e-16, 3.484746188081662e-16, 3.4999530001596647e-16,
	3.515191967270393e-16, 3.5304645207770933e-16, 3.5457721079718235e-16,
	3.56111619309281e-16, 3.576498258367106e-16, 3.5919198050805193e-16,
	3.607382354676874e-16, 3.6228874498887474e-16, 3.638436655901933e-16,
	3.6540315615559904e-16, 3.6696737805833534e-16, 3.685364952889598e-16,
	3.701106745877614e-16, 3.7169008558185697e-16, 3.732749009272722e-16,
	3.7486529645632975e-16, 3.764614513306868e-16, 3.78063548200383e-16,
	3.796717733692844e-16, 3.812863169673307e-16, 3.8290737313002024e-16,
	3.8453514018559483e-16, 3.8616982085041676e-16, 3.8781162243306346e-16,
	3.8946075704770027e-16, 3.9111744183733105e-16, 3.9278189920756757e-16,
	3.9445435707160394e-16, 3.961350491071326e-16, 3.978242150259901e-16,
	3.995221008573811e-16, 4.0122895924559033e-16, 4.02945049763163e-16,
	4.0467063924060794e-16, 4.064060021137607e-16, 4.0815142079003224e-16,
	4.0990718603486767e-16, 4.116735973798462e-16, 4.1345096355396986e-16,
	4.1523960293981775e-16, 4.1703984405638317e-16, 4.1885202607056547e-16,
	4.2067649933945847e-16, 4.225136259857645e-16, 4.2436378050887003e-16,
	4.262273504343447e-16, 4.2810473700487917e-16, 4.2999635591595335e-16,
	4.3190263809983563e-16, 4.338240305618544e-16, 4.3576099727326276e-16,
	4.3771402012543917e-16, 4.396835999506351e-16, 4.4167025761500585e-16,
	4.4367453519024474e-16, 4.456969972107949e-16, 4.477382320243465e-16,
	4.497988532441506e-16, 4.51879501312604e-16, 4.53980845186604e-16,
	4.561035841563454e-16, 4.582484498105624e-16, 4.604162081627236e-16,
	4.626076619543955e-16, 4.648236531539341e-16, 4.67065065670879e-16,
	4.693328283089513e-16, 4.716279179834561e-16, 4.739513632322101e-16,
	4.763042480529397e-16, 4.786877161045007e-16, 4.811029753143727e-16,
	4.83551302940786e-16, 4.860340511447171e-16, 4.885526531349988e-16,
	4.911086299591681e-16, 4.937035980236772e-16, 4.96339277440045e-16,
	4.990175013088311e-16, 5.017402260714605e-16, 5.045095430815269e-16,
	5.07327691573011e-16, 5.101970732338156e-16, 5.131202686303404e-16,
	5.161000557739877e-16, 5.191394311754375e-16, 5.222416337996938e-16,
	5.254101724174328e-16, 5.286488569501704e-16, 5.319618345335188e-16,
	5.353536311813313e-16, 5.388292001330899e-16, 5.423939782198587e-16,
	5.460539519071686e-16, 5.49815735088975e-16, 5.536866612464843e-16,
	5.576748932923575e-16, 5.617895553552448e-16, 5.660408920079487e-16,
	5.704404621288487e-16, 5.750013768917029e-16, 5.797385945721764e-16,
	5.846692893452686e-16, 5.898133176475145e-16, 5.951938149638729e-16,
	6.008379696269235e-16, 6.067780409330819e-16, 6.130527208722697e-16,
	6.19708989457909e-16, 6.268046963298801e-16, 6.34412240712508e-16,
	6.426239659545692e-16, 6.515603317342698e-16, 6.613827885095446e-16,
	6.723150462503459e-16, 6.846803417562237e-16, 6.989718336385731e-16,
	7.159994934828948e-16, 7.372424301797334e-16, 7.658936370804535e-16,
	8.113849337656484e-16,
}
var fn = [256]float64{
	1, 0.977101701282736, 0.9598790918124198, 0.9451989534530815,
	0.9320600759689933, 0.9199915050483631, 0.9087264400605657,
	0.8980959219063067, 0.8879846607634024, 0.8783096558161493,
	0.8690086880437955, 0.860033621203011, 0.8513462584651259,
	0.8429156531184433, 0.8347162929929326, 0.8267268339520965,
	0.8189291916094169, 0.811307874318222, 0.8038494831763916,
	0.7965423304282566, 0.7893761435712006, 0.7823418326598638,
	0.7754313049861402, 0.7686373158033366, 0.7619533468415481,
	0.755373506511756, 0.7488924472237282, 0.7425052963446377,
	0.7362075981312681, 0.7299952645658039, 0.723864533472883,
	0.7178119326349028, 0.7118342488823599, 0.7059285013367987,
	0.7000919181404914, 0.6943219161300339, 0.6886160830085285,
	0.6829721616487928, 0.6773880362225144, 0.6718617199007677,
	0.666391343912382, 0.6609751477802427, 0.6556114705832259,
	0.6502987431142956, 0.6450354808242529, 0.63982027745644,
	0.634651799290961, 0.6295287799281292, 0.6244500155502751,
	0.6194143606090401, 0.6144207238920777, 0.6094680649288963,
	0.6045553907005504, 0.5996817526221685, 0.594846243770992,
	0.5900479963357927, 0.585286179266301, 0.5805599961036841,
	0.5758686829752112, 0.5712115067380757, 0.5665877632589527,
	0.5619967758172788, 0.5574378936214872, 0.5529104904285209,
	0.5484139632579222, 0.543947731192651, 0.5395112342595457,
	0.5351039323830207, 0.5307253044061949, 0.5263748471741877,
	0.5220520746747959, 0.5177565172322015, 0.5134877207497437,
	0.5092452459981369, 0.5050286679458297, 0.500837575128483,
	0.49667156905479726, 0.49253026364614955, 0.488413284707713,
	0.4843202694289125, 0.48025086591125055, 0.47620473272168456,
	0.47218153846988414, 0.46818096140782306, 0.4642026890502797,
	0.4602464178149244, 0.45631185268077457, 0.4523987068638835,
	0.44850670150921507, 0.44463556539772864, 0.4407850346677708,
	0.43695485254993016, 0.43314476911457495, 0.42935454103134246,
	0.42558393133990147, 0.42183270923135413, 0.4181006498396854,
	0.4143875340427075, 0.41069314827198394, 0.4070172843312487,
	0.4033597392228696, 0.3997203149819324, 0.39609881851754786,
	0.3924950614610115, 0.3889088600204653, 0.3853400348417347,
	0.3817884108750321, 0.37825381724723894, 0.37473608713949225,
	0.3712350576698222, 0.367750569780597, 0.36428246813055043,
	0.36083060099117653, 0.3573948201472912, 0.35397498080156986,
	0.35057094148288176, 0.3471825639582521, 0.3438097131482922,
	0.34045225704594634, 0.3371100666384137, 0.3337830158321094,
	0.33047098138053804, 0.3271738428149596, 0.3238914823777331,
	0.32062378495823124, 0.3173706380312235, 0.31413193159763125,
	0.3109075581275648, 0.3076974125055547, 0.30450139197789716,
	0.30131939610203484, 0.29815132669790206, 0.2949970878011633,
	0.29185658561828165, 0.28872972848335454, 0.2856164268166586,
	0.2825165930848499, 0.2794301417627658, 0.27635698929678176,
	0.2732970540696763, 0.2702502563669605, 0.26721651834463234,
	0.26419576399831807, 0.26118791913376427, 0.2581929113386486,
	0.25521066995567776, 0.25224112605694443, 0.24928421241951737,
	0.24633986350223944, 0.2434080154237126, 0.24048860594144975,
	0.23758157443217426, 0.23468686187325324, 0.23180441082524916,
	0.228934165415578, 0.2260760713232653, 0.22323007576478995,
	0.22039612748101192, 0.2175741767251787, 0.2147641752520088,
	0.21196607630785327, 0.20917983462193596, 0.20640540639867963,
	0.20364274931112183, 0.20089182249543167, 0.19815258654653842,
	0.19542500351488587, 0.1927090369043291, 0.1900046516711934,
	0.18731181422451723, 0.18463049242750482, 0.18196065560021685,
	0.17930227452353079, 0.17665532144440702, 0.17401977008249966,
	0.17139559563815585, 0.16878277480185047, 0.16618128576511013,
	0.16359110823298303, 0.16101222343811772, 0.1584446141565203,
	0.15588826472506462, 0.15334316106083776, 0.1508092906824102,
	0.14828664273312872, 0.14577520800653793, 0.14327497897404712,
	0.1407859498149683, 0.13830811644906432, 0.13584147657175735,
	0.13338602969216284, 0.13094177717412817, 0.12850872228047364,
	0.12608687022065035, 0.1236762282020514, 0.12127680548523544,
	0.1188886134433457, 0.11651166562603701, 0.11414597782825521,
	0.11179156816424558, 0.10944845714721002, 0.10711666777507288,
	0.10479622562286704, 0.10248715894230627, 0.10018949876917202,
	0.09790327903921564, 0.09562853671335333, 0.09336531191302662,
	0.09111364806670073, 0.08887359206859423, 0.08664519445086778,
	0.08442850957065466, 0.08222359581349568, 0.08003051581494751,
	0.07784933670237221, 0.07568013035919496, 0.07352297371424099,
	0.07137794905914197, 0.06924514439725027, 0.06712465382802399,
	0.06501657797147044, 0.06292102443797785, 0.060838108349751806,
	0.058767952921137984, 0.05671069010639947, 0.054666461325077916,
	0.05263541827697365, 0.05061772386112179, 0.048613553216035145,
	0.046623094902089664, 0.044646552251446536, 0.04268414491661938,
	0.04073611065607875, 0.03880270740465692, 0.03688421568869115,
	0.03498094146183307, 0.0330932194586887, 0.03122141719202369,
	0.02936593975823011, 0.02752723566969332, 0.025705804008632656,
	0.023902203305873237, 0.022117062707379922, 0.020351096230109358,
	0.01860512127578335, 0.01688008315259584, 0.015177088307982072,
	0.013497450601780807, 0.011842757857943106, 0.0102149714397311,
	0.008616582769422917, 0.00705087547139211, 0.005522403299264755,
	0.0040379725933718715, 0.002609072746106363, 0.001260285930498598,
}

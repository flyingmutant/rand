// Copyright 2009 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE-go file.

package rand

import (
	"math"
)

/*
 * Normal distribution
 *
 * See "The Ziggurat Method for Generating Random Variables"
 * (Marsaglia & Tsang, 2000)
 * http://www.jstatsoft.org/v05/i08/paper [pdf]
 */

const (
	rn = 3.442619855899
)

func absInt32(i int32) uint32 {
	if i < 0 {
		return uint32(-i)
	}
	return uint32(i)
}

// NormFloat64 returns a normally distributed float64 in
// the range -math.MaxFloat64 through +math.MaxFloat64 inclusive,
// with standard normal distribution (mean = 0, stddev = 1).
// To produce a different normal distribution, callers can
// adjust the output using:
//
//  sample = NormFloat64() * desiredStdDev + desiredMean
//
func (r *Rand) NormFloat64() float64 {
	for {
		j := int32(r.Uint32()) // Possibly negative
		i := j & 0x7F
		x := float64(j) * wn[i]
		if absInt32(j) < kn[i] {
			// This case should be hit better than 99% of the time.
			return x
		}

		if i == 0 {
			// This extra work is only required for the base strip.
			for {
				x = -math.Log(r.Float64()) * (1.0 / rn)
				y := -math.Log(r.Float64())
				if y+y >= x*x {
					break
				}
			}
			if j > 0 {
				return rn + x
			}
			return -rn - x
		}
		if fn[i]+r.Float64()*(fn[i-1]-fn[i]) < math.Exp(-.5*x*x) {
			return x
		}
	}
}

var kn = [128]uint32{
	0x76ad2212, 0x0, 0x600f1b53, 0x6ce447a6, 0x725b46a2,
	0x7560051d, 0x774921eb, 0x789a25bd, 0x799045c3, 0x7a4bce5d,
	0x7adf629f, 0x7b5682a6, 0x7bb8a8c6, 0x7c0ae722, 0x7c50cce7,
	0x7c8cec5b, 0x7cc12cd6, 0x7ceefed2, 0x7d177e0b, 0x7d3b8883,
	0x7d5bce6c, 0x7d78dd64, 0x7d932886, 0x7dab0e57, 0x7dc0dd30,
	0x7dd4d688, 0x7de73185, 0x7df81cea, 0x7e07c0a3, 0x7e163efa,
	0x7e23b587, 0x7e303dfd, 0x7e3beec2, 0x7e46db77, 0x7e51155d,
	0x7e5aabb3, 0x7e63abf7, 0x7e6c222c, 0x7e741906, 0x7e7b9a18,
	0x7e82adfa, 0x7e895c63, 0x7e8fac4b, 0x7e95a3fb, 0x7e9b4924,
	0x7ea0a0ef, 0x7ea5b00d, 0x7eaa7ac3, 0x7eaf04f3, 0x7eb3522a,
	0x7eb765a5, 0x7ebb4259, 0x7ebeeafd, 0x7ec2620a, 0x7ec5a9c4,
	0x7ec8c441, 0x7ecbb365, 0x7ece78ed, 0x7ed11671, 0x7ed38d62,
	0x7ed5df12, 0x7ed80cb4, 0x7eda175c, 0x7edc0005, 0x7eddc78e,
	0x7edf6ebf, 0x7ee0f647, 0x7ee25ebe, 0x7ee3a8a9, 0x7ee4d473,
	0x7ee5e276, 0x7ee6d2f5, 0x7ee7a620, 0x7ee85c10, 0x7ee8f4cd,
	0x7ee97047, 0x7ee9ce59, 0x7eea0eca, 0x7eea3147, 0x7eea3568,
	0x7eea1aab, 0x7ee9e071, 0x7ee98602, 0x7ee90a88, 0x7ee86d08,
	0x7ee7ac6a, 0x7ee6c769, 0x7ee5bc9c, 0x7ee48a67, 0x7ee32efc,
	0x7ee1a857, 0x7edff42f, 0x7ede0ffa, 0x7edbf8d9, 0x7ed9ab94,
	0x7ed7248d, 0x7ed45fae, 0x7ed1585c, 0x7ece095f, 0x7eca6ccb,
	0x7ec67be2, 0x7ec22eee, 0x7ebd7d1a, 0x7eb85c35, 0x7eb2c075,
	0x7eac9c20, 0x7ea5df27, 0x7e9e769f, 0x7e964c16, 0x7e8d44ba,
	0x7e834033, 0x7e781728, 0x7e6b9933, 0x7e5d8a1a, 0x7e4d9ded,
	0x7e3b737a, 0x7e268c2f, 0x7e0e3ff5, 0x7df1aa5d, 0x7dcf8c72,
	0x7da61a1e, 0x7d72a0fb, 0x7d30e097, 0x7cd9b4ab, 0x7c600f1a,
	0x7ba90bdc, 0x7a722176, 0x77d664e5,
}
var wn = [128]float64{
	1.729040521542798e-09, 1.2680928447002152e-10, 1.6897517773184155e-10,
	1.9862688442478744e-10, 2.22324317924997e-10, 2.4244936125448714e-10,
	2.6016131900631873e-10, 2.761198871170378e-10, 2.907396281771582e-10,
	3.042997041437645e-10, 3.169979521395413e-10, 3.289802052711293e-10,
	3.4035738121833935e-10, 3.512160221366459e-10, 3.616250995056505e-10,
	3.716405763495967e-10, 3.8130856431105866e-10, 3.9066756809948713e-10,
	3.9975011869976804e-10, 4.0858398615984305e-10, 4.171930964016054e-10,
	4.255982353459251e-10, 4.3381759739254987e-10, 4.4186721812528734e-10,
	4.49761319626657e-10, 4.575125889458818e-10, 4.6513240481399984e-10,
	4.726310238481165e-10, 4.800177347232558e-10, 4.873009867798739e-10,
	4.944884980538965e-10, 5.015873466119609e-10, 5.086040482424554e-10,
	5.155446229195384e-10, 5.224146519706309e-10, 5.292193275006299e-10,
	5.359634953312884e-10, 5.426516924820614e-10, 5.492881800346016e-10,
	5.558769720760768e-10, 5.624218612983583e-10, 5.689264417346546e-10,
	5.753941290375599e-10, 5.818281786390895e-10, 5.882317020812166e-10,
	5.946076817624991e-10, 6.009589843108299e-10, 6.072883727627882e-10,
	6.135985177054132e-10, 6.198920075155919e-10, 6.261713578149426e-10,
	6.324390202435399e-10, 6.386973906435734e-10, 6.449488167337381e-10,
	6.511956053464696e-10, 6.574400292928597e-10, 6.636843339139873e-10,
	6.6993074337233e-10, 6.761814667327442e-10, 6.824387038791136e-10,
	6.887046513100733e-10, 6.949815078551667e-10, 7.012714803513155e-10,
	7.075767893185559e-10, 7.138996746735849e-10, 7.202424015197486e-10,
	7.266072660527047e-10, 7.329966016220864e-10, 7.394127849911228e-10,
	7.458582428383539e-10, 7.523354585483488e-10, 7.588469793417652e-10,
	7.653954237992263e-10, 7.7198348983844e-10, 7.786139632098381e-10,
	7.852897265828997e-10, 7.920137693034098e-10, 7.987891979113536e-10,
	8.05619247520217e-10, 8.125072941713968e-10, 8.194568682925745e-10,
	8.264716694066623e-10, 8.335555822587844e-10, 8.40712694553299e-10,
	8.479473165218371e-10, 8.552640025776093e-10, 8.626675753519362e-10,
	8.701631524574423e-10, 8.777561763803284e-10, 8.854524479737278e-10,
	8.932581641080369e-10, 9.011799601356605e-10, 9.092249579511381e-10,
	9.174008205786005e-10, 9.257158144040126e-10, 9.341788803988472e-10,
	9.427997159666314e-10, 9.515888693998883e-10, 9.605578493831253e-10,
	9.697192525453944e-10, 9.7908691279089e-10, 9.886760770687724e-10,
	9.985036134535425e-10, 1.0085882589914473e-09, 1.0189509168621382e-09,
	1.0296150152006668e-09, 1.0406069436999874e-09, 1.0519565892728039e-09,
	1.0636979991930871e-09, 1.0758702101645819e-09, 1.0885182960607283e-09,
	1.1016947078135044e-09, 1.1154610095597163e-09, 1.1298901613493216e-09,
	1.1450695700067237e-09, 1.1611052426022348e-09, 1.178127560945613e-09,
	1.1962995053850756e-09, 1.2158286983295564e-09, 1.2369856290804966e-09,
	1.2601323300608525e-09, 1.2857696844205153e-09, 1.3146201849677183e-09,
	1.3477839562210855e-09, 1.3870635315067043e-09, 1.435740319181638e-09,
	1.5008659030222993e-09, 1.6030947938091123e-09,
}
var fn = [128]float64{
	1, 0.9635996931270896, 0.9362826816850625, 0.9130436479717428,
	0.8922816507840284, 0.8732430489100717, 0.8555006078694526,
	0.8387836052959915, 0.8229072113814108, 0.8077382946829622,
	0.7931770117713067, 0.7791460859296893, 0.765584173897706,
	0.7524415591746129, 0.7396772436726488, 0.7272569183441863,
	0.7151515074105, 0.7033360990161595, 0.6917891434366764,
	0.6804918409973354, 0.6694276673488917, 0.6585820000500895,
	0.647941821110224, 0.6374954773350439, 0.6272324852499288,
	0.6171433708188824, 0.6072195366251217, 0.5974531509445181,
	0.5878370544347078, 0.5783646811197644, 0.569029991067952,
	0.5598274127040879, 0.5507517931146054, 0.5417983550254263,
	0.5329626593838369, 0.5242405726729849, 0.5156282382440026,
	0.5071220510755696, 0.49871863547098017, 0.4904148252838448,
	0.4822076463294858, 0.47409430069301745, 0.4660721526894566,
	0.4581387162678725, 0.4502916436820397, 0.44252871527546894,
	0.4348478302499913, 0.42724699830499646, 0.41972433204957477,
	0.4122780401026614, 0.40490642080722333, 0.39760785649387365,
	0.39038080823731486, 0.38322381105590136, 0.3761354695105628,
	0.36911445366447243, 0.3621594953693178, 0.35526938484791737,
	0.3484429675463268, 0.3416791412315506, 0.33497685331358923,
	0.3283350983728503, 0.3217529158759849, 0.31522938806501094,
	0.3087636380061812, 0.30235482778648354, 0.296002156846933,
	0.28970486044295984, 0.283462208223233, 0.2772735029191881,
	0.2711380791383846, 0.2650553022555892, 0.25902456739620483,
	0.25304529850732577, 0.2471169475123214, 0.24123899354543982,
	0.23541094226347908, 0.22963232523211613, 0.22390269938500842,
	0.21822164655430543, 0.21258877307173027, 0.2070037094399266,
	0.20146611007431373, 0.1959756531162778, 0.19053204031913723,
	0.18513499700899227, 0.17978427212329554, 0.17447963833078958,
	0.169220892237365, 0.16400785468342038, 0.1588403711394793,
	0.15371831220818166, 0.14864157424234226, 0.14361008009062776,
	0.1386237799845946, 0.13368265258343937, 0.1287867061959432,
	0.12393598020286782, 0.11913054670765083, 0.11437051244886601,
	0.10965602101484027, 0.10498725540942132, 0.10036444102865587,
	0.09578784912173144, 0.09125780082683026, 0.08677467189478019,
	0.08233889824223567, 0.0779509825139734, 0.0736115018841134,
	0.06932111739357791, 0.06508058521306807, 0.060890770348040406,
	0.05675266348104985, 0.052667401903051005, 0.048636295859867805,
	0.044660862200491425, 0.040742868074444175, 0.0368843887866562,
	0.03308788614622575, 0.02935631744000685, 0.02569329193593427,
	0.022103304615927098, 0.018592102737011288, 0.015167298010546568,
	0.011839478657884862, 0.008624484412859885, 0.005548995220771345,
	0.002669629083880923,
}

// Copyright 2009 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE-go file.

package rand

import (
	"math"
)

/*
 * Normal distribution
 *
 * See "The Ziggurat Method for Generating Random Variables"
 * (Marsaglia & Tsang, 2000)
 * http://www.jstatsoft.org/v05/i08/paper [pdf]
 *
 * Fixed correlation, see https://github.com/flyingmutant/rand/issues/3
 */

const (
	rn = 3.6541528853610088
)

func absInt64(i int64) uint64 {
	if i < 0 {
		return uint64(-i)
	}
	return uint64(i)
}

// NormFloat64 returns a normally distributed float64 in
// the range -math.MaxFloat64 through +math.MaxFloat64 inclusive,
// with standard normal distribution (mean = 0, stddev = 1).
// To produce a different normal distribution, callers can
// adjust the output using:
//
//  sample = NormFloat64() * desiredStdDev + desiredMean
//
func (r *Rand) NormFloat64() float64 {
	for {
		v := r.Uint64()
		j := int64(int32(uint32(v >> 8))) // Possibly negative
		i := v & 0xFF
		x := float64(j) * wn[i]
		if absInt64(j) < kn[i] {
			// This case should be hit better than 99% of the time.
			return x
		}

		if i == 0 {
			// This extra work is only required for the base strip.
			for {
				x = -math.Log(r.Float64()) * (1.0 / rn)
				y := -math.Log(r.Float64())
				if y+y >= x*x {
					break
				}
			}
			if j > 0 {
				return rn + x
			}
			return -rn - x
		}
		if fn[i]+r.Float64()*(fn[i-1]-fn[i]) < math.Exp(-.5*x*x) {
			return x
		}
	}
}

var kn = [256]uint64{
	0x7799ec01, 0x0, 0x6045f4c7, 0x6d1aa7d5, 0x728fb3f6, 0x7592af4e,
	0x777a5c0b, 0x78ca3857, 0x79bf6b0f, 0x7a7a34ab, 0x7b0d2f20, 0x7b83d3aa,
	0x7be59761, 0x7c378863, 0x7c7d32bc, 0x7cb9263a, 0x7ced483e, 0x7d1b07ac,
	0x7d437ef2, 0x7d678b06, 0x7d87db38, 0x7da4fc6a, 0x7dbf611b, 0x7dd7674d,
	0x7ded5ce8, 0x7e018307, 0x7e141081, 0x7e2533d7, 0x7e3514bb, 0x7e43d549,
	0x7e5192f2, 0x7e5e6748, 0x7e6a6897, 0x7e75aa6c, 0x7e803df8, 0x7e8a326e,
	0x7e939547, 0x7e9c727f, 0x7ea4d4cc, 0x7eacc5c4, 0x7eb44e04, 0x7ebb754e,
	0x7ec242a3, 0x7ec8bc5d, 0x7ecee83d, 0x7ed4cb80, 0x7eda6aee, 0x7edfcae2,
	0x7ee4ef5d, 0x7ee9dc08, 0x7eee9441, 0x7ef31b21, 0x7ef77384, 0x7efba00d,
	0x7effa32c, 0x7f037f25, 0x7f073611, 0x7f0ac9e1, 0x7f0e3c65, 0x7f118f4e,
	0x7f14c42e, 0x7f17dc7d, 0x7f1ad99a, 0x7f1dbcce, 0x7f20874c, 0x7f233a36,
	0x7f25d69a, 0x7f285d76, 0x7f2acfba, 0x7f2d2e47, 0x7f2f79f0, 0x7f31b37e,
	0x7f33dbae, 0x7f35f330, 0x7f37faaf, 0x7f39f2c8, 0x7f3bdc11, 0x7f3db71b,
	0x7f3f846b, 0x7f414482, 0x7f42f7d9, 0x7f449ee4, 0x7f463a0f, 0x7f47c9c3,
	0x7f494e64, 0x7f4ac84e, 0x7f4c37dc, 0x7f4d9d63, 0x7f4ef934, 0x7f504b9d,
	0x7f5194e7, 0x7f52d559, 0x7f540d36, 0x7f553cbe, 0x7f56642f, 0x7f5783c3,
	0x7f589bb1, 0x7f59ac2f, 0x7f5ab571, 0x7f5bb7a7, 0x7f5cb2ff, 0x7f5da7a6,
	0x7f5e95c7, 0x7f5f7d8b, 0x7f605f18, 0x7f613a95, 0x7f621024, 0x7f62dfe9,
	0x7f63aa03, 0x7f646e92, 0x7f652db4, 0x7f65e786, 0x7f669c22, 0x7f674ba4,
	0x7f67f623, 0x7f689bb9, 0x7f693c7c, 0x7f69d881, 0x7f6a6fdd, 0x7f6b02a4,
	0x7f6b90ea, 0x7f6c1abf, 0x7f6ca035, 0x7f6d215c, 0x7f6d9e43, 0x7f6e16fa,
	0x7f6e8b8d, 0x7f6efc09, 0x7f6f687c, 0x7f6fd0f0, 0x7f703570, 0x7f709606,
	0x7f70f2bc, 0x7f714b9a, 0x7f71a0a8, 0x7f71f1ed, 0x7f723f71, 0x7f728938,
	0x7f72cf4a, 0x7f7311a9, 0x7f73505a, 0x7f738b61, 0x7f73c2c1, 0x7f73f67b,
	0x7f742692, 0x7f745305, 0x7f747bd6, 0x7f74a103, 0x7f74c28d, 0x7f74e070,
	0x7f74faab, 0x7f75113b, 0x7f75241b, 0x7f753347, 0x7f753ebb, 0x7f754670,
	0x7f754a5f, 0x7f754a81, 0x7f7546ce, 0x7f753f3c, 0x7f7533c2, 0x7f752455,
	0x7f7510e9, 0x7f74f971, 0x7f74dde1, 0x7f74be29, 0x7f749a39, 0x7f747202,
	0x7f744571, 0x7f741473, 0x7f73def5, 0x7f73a4df, 0x7f73661d, 0x7f732294,
	0x7f72da2d, 0x7f728cca, 0x7f723a50, 0x7f71e29f, 0x7f718597, 0x7f712315,
	0x7f70baf5, 0x7f704d11, 0x7f6fd93f, 0x7f6f5f53, 0x7f6edf21, 0x7f6e5876,
	0x7f6dcb20, 0x7f6d36e7, 0x7f6c9b91, 0x7f6bf8e1, 0x7f6b4e95, 0x7f6a9c68,
	0x7f69e20e, 0x7f691f3b, 0x7f685399, 0x7f677ed0, 0x7f66a080, 0x7f65b844,
	0x7f64c5b0, 0x7f63c850, 0x7f62bfa8, 0x7f61ab34, 0x7f608a65, 0x7f5f5ca4,
	0x7f5e214d, 0x7f5cd7af, 0x7f5b7f0e, 0x7f5a169d, 0x7f589d80, 0x7f5712c8,
	0x7f557574, 0x7f53c46c, 0x7f51fe7f, 0x7f502264, 0x7f4e2eb1, 0x7f4c21dd,
	0x7f49fa38, 0x7f47b5eb, 0x7f4552ee, 0x7f42cf03, 0x7f4027b4, 0x7f3d5a44,
	0x7f3a63a8, 0x7f374081, 0x7f33ed05, 0x7f3064f9, 0x7f2ca399, 0x7f28a384,
	0x7f245ea1, 0x7f1fcdff, 0x7f1ae9af, 0x7f15a891, 0x7f10001c, 0x7f09e413,
	0x7f034627, 0x7efc1581, 0x7ef43e2b, 0x7eeba84e, 0x7ee23729, 0x7ed7c7c1,
	0x7ecc2f0d, 0x7ebf377a, 0x7eb09d6d, 0x7ea00a4f, 0x7e8d0d3d, 0x7e771023,
	0x7e5d46c2, 0x7e3e9376, 0x7e195978, 0x7deb2c0e, 0x7db03620, 0x7d6202c1,
	0x7cf4b8f0, 0x7c4fd245, 0x7b362fbf, 0x78d2d259,
}
var wn = [256]float64{
	1.821088585787029e-09, 1.0022981833352318e-10, 1.3326042878778947e-10,
	1.563399653790745e-10, 1.7467948275173867e-10, 1.9017101013473844e-10,
	2.0373538238306328e-10, 2.1589656210120619e-10, 2.2698378475464343e-10,
	2.3721872343957795e-10, 2.467584426731291e-10, 2.5571868862631814e-10,
	2.641874631123936e-10, 2.722333958808881e-10, 2.7991115010526775e-10,
	2.872650464979146e-10, 2.9433157126187376e-10, 3.011411590894614e-10,
	3.0771949059991264e-10, 3.140884557866644e-10, 3.202668823237782e-10,
	3.262710948929102e-10, 3.321153508415536e-10, 3.378121838445311e-10,
	3.433726781168188e-10, 3.4880668949781865e-10, 3.541230253978077e-10,
	3.59329592537478e-10, 3.6443351921606167e-10, 3.6944125724637426e-10,
	3.743586675183207e-10, 3.791910922751119e-10, 3.8394341652527745e-10,
	3.8862012051023376e-10, 3.9322532476038734e-10, 3.977628289729162e-10,
	4.022361457100252e-10, 4.0664852973189774e-10, 4.1100300363214123e-10,
	4.1530238032657195e-10, 4.1954928285217486e-10, 4.237461618570456e-10,
	4.2789531110028415e-10, 4.3199888123023934e-10, 4.360588920679387e-10,
	4.4007724358819866e-10, 4.440557257624208e-10, 4.479960274033266e-10,
	4.518997441320043e-10, 4.557683855709323e-10, 4.596033818525471e-10,
	4.63406089520986e-10, 4.671777968944935e-10, 4.709197289473271e-10,
	4.746330517626032e-10, 4.783188766011736e-10, 4.819782636261565e-10,
	4.856122253180339e-10, 4.892217296111425e-10, 4.92807702778841e-10,
	4.963710320915585e-10, 4.999125682692371e-10, 5.034331277473307e-10,
	5.069334947734663e-10, 5.104144233500593e-10, 5.138766390365858e-10,
	5.173208406238108e-10, 5.207477016910264e-10, 5.241578720562592e-10,
	5.275519791284275e-10, 5.309306291695657e-10, 5.342944084744586e-10,
	5.376438844743421e-10, 5.409796067707114e-10, 5.443021081047283e-10,
	5.476119052672238e-10, 5.509094999538544e-10, 5.541953795695678e-10,
	5.574700179861786e-10, 5.607338762565323e-10, 5.639874032884417e-10,
	5.672310364813196e-10, 5.704652023281932e-10, 5.736903169855678e-10,
	5.769067868134127e-10, 5.801150088873675e-10, 5.833153714850992e-10,
	5.865082545486011e-10, 5.896940301240825e-10, 5.928730627809848e-10,
	5.960457100115398e-10, 5.992123226121929e-10, 6.023732450481113e-10,
	6.055288158019223e-10, 6.086793677077407e-10, 6.118252282714785e-10,
	6.149667199783626e-10, 6.181041605885249e-10, 6.212378634214784e-10,
	6.243681376302386e-10, 6.274952884658044e-10, 6.30619617532673e-10,
	6.337414230360186e-10, 6.368610000211357e-10, 6.399786406057091e-10,
	6.430946342054478e-10, 6.462092677535876e-10, 6.493228259147469e-10,
	6.524355912935925e-10, 6.555478446387546e-10, 6.586598650424104e-10,
	6.617719301359363e-10, 6.648843162820157e-10, 6.679972987635738e-10,
	6.71111151969897e-10, 6.742261495802871e-10, 6.773425647455836e-10,
	6.804606702678866e-10, 6.835807387787984e-10, 6.86703042916499e-10,
	6.898278555019637e-10, 6.929554497146292e-10, 6.960860992678052e-10,
	6.992200785841347e-10, 7.023576629713968e-10, 7.054991287989496e-10,
	7.08644753675112e-10, 7.117948166257806e-10, 7.149495982745854e-10,
	7.181093810248868e-10, 7.212744492439246e-10, 7.244450894494324e-10,
	7.276215904990389e-10, 7.308042437827833e-10, 7.339933434190841e-10,
	7.37189186454504e-10, 7.403920730676723e-10, 7.436023067777326e-10,
	7.468201946576973e-10, 7.500460475531093e-10, 7.532801803064221e-10,
	7.565229119875316e-10, 7.597745661309086e-10, 7.63035470979805e-10,
	7.663059597380268e-10, 7.695863708297941e-10, 7.728770481682326e-10,
	7.76178341433073e-10, 7.794906063581625e-10, 7.828142050294307e-10,
	7.861495061939848e-10, 7.894968855810525e-10, 7.928567262355296e-10,
	7.962294188649415e-10, 7.996153622006715e-10, 8.030149633743682e-10,
	8.064286383105006e-10, 8.098568121360932e-10, 8.132999196087439e-10,
	8.167584055640987e-10, 8.202327253840425e-10, 8.237233454869488e-10,
	8.272307438414284e-10, 8.307554105051213e-10, 8.342978481901852e-10,
	8.378585728572585e-10, 8.414381143398083e-10, 8.450370170009168e-10,
	8.486558404247194e-10, 8.522951601448775e-10, 8.559555684126577e-10,
	8.596376750073948e-10, 8.633421080923392e-10, 8.67069515119135e-10,
	8.708205637844447e-10, 8.745959430425321e-10, 8.783963641779385e-10,
	8.82222561942744e-10, 8.86075295763298e-10, 8.899553510217378e-10,
	8.938635404180869e-10, 8.978007054192564e-10, 9.017677178018534e-10,
	9.057654812963465e-10, 9.09794933340854e-10, 9.138570469536175e-10,
	9.17952832734105e-10, 9.220833410036743e-10, 9.262496640978248e-10,
	9.304529388232921e-10, 9.34694349094613e-10, 9.389751287663224e-10,
	9.432965646786769e-10, 9.4765999993673e-10, 9.52066837444777e-10,
	9.56518543720648e-10, 9.610166530171206e-10, 9.655627717808721e-10,
	9.701585834829844e-10, 9.748058538590792e-10, 9.795064366018152e-10,
	9.842622795537738e-10, 9.890754314548409e-10, 9.93948049305156e-10,
	9.988824064127186e-10, 1.003880901203986e-09, 1.0089460668864874e-09,
	1.0140805820648752e-09, 1.0192872824262458e-09, 1.0245691736273691e-09,
	1.0299294455361293e-09, 1.0353714880025507e-09, 1.0408989083619453e-09,
	1.0465155509048178e-09, 1.0522255185862155e-09, 1.0580331972925104e-09,
	1.063943283037723e-09, 1.0699608125264428e-09, 1.0760911975986557e-09,
	1.0823402641665298e-09, 1.088714296368431e-09, 1.0952200868062954e-09,
	1.1018649939055641e-09, 1.1086570076507637e-09, 1.115604825215638e-09,
	1.1227179383391913e-09, 1.1300067347175097e-09, 1.1374826162117332e-09,
	1.1451581373500225e-09, 1.1530471684733142e-09, 1.161165089006387e-09,
	1.169529017817854e-09, 1.1781580895923623e-09, 1.1870737887562536e-09,
	1.1963003560344393e-09, 1.2058652875511885e-09, 1.2157999530842288e-09,
	1.2261403694890088e-09, 1.2369281787311204e-09, 1.248211899439116e-09,
	1.2600485496790419e-09, 1.2725057820988945e-09, 1.2856647396827222e-09,
	1.2996239466596328e-09, 1.3145047225176008e-09, 1.3304588994347176e-09,
	1.3476801354495567e-09, 1.3664210528171874e-09, 1.3870202376883686e-09,
	1.4099468438740053e-09, 1.4358787480747481e-09, 1.4658501788588008e-09,
	1.5015597697566399e-09, 1.5461094369362882e-09, 1.6061953727905473e-09,
	1.7015975366164971e-09,
}
var fn = [256]float64{
	1, 0.977101701282736, 0.9598790918124198, 0.9451989534530815,
	0.9320600759689933, 0.9199915050483631, 0.9087264400605657,
	0.8980959219063067, 0.8879846607634024, 0.8783096558161493,
	0.8690086880437955, 0.860033621203011, 0.8513462584651259,
	0.8429156531184433, 0.8347162929929326, 0.8267268339520965,
	0.8189291916094169, 0.811307874318222, 0.8038494831763916,
	0.7965423304282566, 0.7893761435712006, 0.7823418326598638,
	0.7754313049861402, 0.7686373158033366, 0.7619533468415481,
	0.755373506511756, 0.7488924472237282, 0.7425052963446377,
	0.7362075981312681, 0.7299952645658039, 0.723864533472883,
	0.7178119326349028, 0.7118342488823599, 0.7059285013367987,
	0.7000919181404914, 0.6943219161300339, 0.6886160830085285,
	0.6829721616487928, 0.6773880362225144, 0.6718617199007677,
	0.666391343912382, 0.6609751477802427, 0.6556114705832259,
	0.6502987431142956, 0.6450354808242529, 0.63982027745644,
	0.634651799290961, 0.6295287799281292, 0.6244500155502751,
	0.6194143606090401, 0.6144207238920777, 0.6094680649288963,
	0.6045553907005504, 0.5996817526221685, 0.594846243770992,
	0.5900479963357927, 0.585286179266301, 0.5805599961036841,
	0.5758686829752112, 0.5712115067380757, 0.5665877632589527,
	0.5619967758172788, 0.5574378936214872, 0.5529104904285209,
	0.5484139632579222, 0.543947731192651, 0.5395112342595457,
	0.5351039323830207, 0.5307253044061949, 0.5263748471741877,
	0.5220520746747959, 0.5177565172322015, 0.5134877207497437,
	0.5092452459981369, 0.5050286679458297, 0.500837575128483,
	0.49667156905479726, 0.49253026364614955, 0.488413284707713,
	0.4843202694289125, 0.48025086591125055, 0.47620473272168456,
	0.47218153846988414, 0.46818096140782306, 0.4642026890502797,
	0.4602464178149244, 0.45631185268077457, 0.4523987068638835,
	0.44850670150921507, 0.44463556539772864, 0.4407850346677708,
	0.43695485254993016, 0.43314476911457495, 0.42935454103134246,
	0.42558393133990147, 0.42183270923135413, 0.4181006498396854,
	0.4143875340427075, 0.41069314827198394, 0.4070172843312487,
	0.4033597392228696, 0.3997203149819324, 0.39609881851754786,
	0.3924950614610115, 0.3889088600204653, 0.3853400348417347,
	0.3817884108750321, 0.37825381724723894, 0.37473608713949225,
	0.3712350576698222, 0.367750569780597, 0.36428246813055043,
	0.36083060099117653, 0.3573948201472912, 0.35397498080156986,
	0.35057094148288176, 0.3471825639582521, 0.3438097131482922,
	0.34045225704594634, 0.3371100666384137, 0.3337830158321094,
	0.33047098138053804, 0.3271738428149596, 0.3238914823777331,
	0.32062378495823124, 0.3173706380312235, 0.31413193159763125,
	0.3109075581275648, 0.3076974125055547, 0.30450139197789716,
	0.30131939610203484, 0.29815132669790206, 0.2949970878011633,
	0.29185658561828165, 0.28872972848335454, 0.2856164268166586,
	0.2825165930848499, 0.2794301417627658, 0.27635698929678176,
	0.2732970540696763, 0.2702502563669605, 0.26721651834463234,
	0.26419576399831807, 0.26118791913376427, 0.2581929113386486,
	0.25521066995567776, 0.25224112605694443, 0.24928421241951737,
	0.24633986350223944, 0.2434080154237126, 0.24048860594144975,
	0.23758157443217426, 0.23468686187325324, 0.23180441082524916,
	0.228934165415578, 0.2260760713232653, 0.22323007576478995,
	0.22039612748101192, 0.2175741767251787, 0.2147641752520088,
	0.21196607630785327, 0.20917983462193596, 0.20640540639867963,
	0.20364274931112183, 0.20089182249543167, 0.19815258654653842,
	0.19542500351488587, 0.1927090369043291, 0.1900046516711934,
	0.18731181422451723, 0.18463049242750482, 0.18196065560021685,
	0.17930227452353079, 0.17665532144440702, 0.17401977008249966,
	0.17139559563815585, 0.16878277480185047, 0.16618128576511013,
	0.16359110823298303, 0.16101222343811772, 0.1584446141565203,
	0.15588826472506462, 0.15334316106083776, 0.1508092906824102,
	0.14828664273312872, 0.14577520800653793, 0.14327497897404712,
	0.1407859498149683, 0.13830811644906432, 0.13584147657175735,
	0.13338602969216284, 0.13094177717412817, 0.12850872228047364,
	0.12608687022065035, 0.1236762282020514, 0.12127680548523544,
	0.1188886134433457, 0.11651166562603701, 0.11414597782825521,
	0.11179156816424558, 0.10944845714721002, 0.10711666777507288,
	0.10479622562286704, 0.10248715894230627, 0.10018949876917202,
	0.09790327903921564, 0.09562853671335333, 0.09336531191302662,
	0.09111364806670073, 0.08887359206859423, 0.08664519445086778,
	0.08442850957065466, 0.08222359581349568, 0.08003051581494751,
	0.07784933670237221, 0.07568013035919496, 0.07352297371424099,
	0.07137794905914197, 0.06924514439725027, 0.06712465382802399,
	0.06501657797147044, 0.06292102443797785, 0.060838108349751806,
	0.058767952921137984, 0.05671069010639947, 0.054666461325077916,
	0.05263541827697365, 0.05061772386112179, 0.048613553216035145,
	0.046623094902089664, 0.044646552251446536, 0.04268414491661938,
	0.04073611065607875, 0.03880270740465692, 0.03688421568869115,
	0.03498094146183307, 0.0330932194586887, 0.03122141719202369,
	0.02936593975823011, 0.02752723566969332, 0.025705804008632656,
	0.023902203305873237, 0.022117062707379922, 0.020351096230109358,
	0.01860512127578335, 0.01688008315259584, 0.015177088307982072,
	0.013497450601780807, 0.011842757857943106, 0.0102149714397311,
	0.008616582769422917, 0.00705087547139211, 0.005522403299264755,
	0.0040379725933718715, 0.002609072746106363, 0.001260285930498598,
}
